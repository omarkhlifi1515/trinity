package com.redtrinity.pentest.fragments

import android.os.Bundle
import android.util.Patterns
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import android.widget.Button
import android.widget.Toast
import androidx.fragment.app.Fragment
import androidx.lifecycle.lifecycleScope
import com.google.android.material.textfield.TextInputEditText
import com.redtrinity.pentest.R
import com.redtrinity.pentest.network.RetrofitClient
import com.redtrinity.pentest.utils.PreferenceHelper
import kotlinx.coroutines.CancellationException
import kotlinx.coroutines.launch

class SettingsFragment : Fragment() {
    
    private lateinit var ipInput: TextInputEditText
    private lateinit var portInput: TextInputEditText
    private lateinit var saveButton: Button
    private lateinit var testButton: Button
    
    override fun onCreateView(
        inflater: LayoutInflater,
        container: ViewGroup?,
        savedInstanceState: Bundle?
    ): View? {
        return inflater.inflate(R.layout.fragment_settings, container, false)
    }
    
    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
        super.onViewCreated(view, savedInstanceState)
        
        ipInput = view.findViewById(R.id.editWorkstationIp)
        portInput = view.findViewById(R.id.editPort)
        saveButton = view.findViewById(R.id.btnSaveSettings)
        testButton = view.findViewById(R.id.btnTestConnection)
        
        // Load current settings
        ipInput.setText(PreferenceHelper.getWorkstationIp(requireContext()))
        portInput.setText(PreferenceHelper.getPort(requireContext()))
        
        saveButton.setOnClickListener {
            saveSettings()
        }
        
        testButton.setOnClickListener {
            testConnection()
        }
    }
    
    private fun saveSettings() {
        val ip = ipInput.text?.toString() ?: ""
        val port = portInput.text?.toString() ?: ""
        
        if (ip.isEmpty() || port.isEmpty()) {
            Toast.makeText(requireContext(), "Please fill all fields", Toast.LENGTH_SHORT).show()
            return
        }
        
        PreferenceHelper.setWorkstationIp(requireContext(), ip)
        PreferenceHelper.setPort(requireContext(), port)
        
        Toast.makeText(requireContext(), "Settings saved!", Toast.LENGTH_SHORT).show()
    }
    
    private fun testConnection() {
        val ip = ipInput.text?.toString()?.trim() ?: ""
        val port = portInput.text?.toString()?.trim() ?: ""
        
        if (ip.isEmpty() || port.isEmpty()) {
            Toast.makeText(requireContext(), "Please fill all fields", Toast.LENGTH_SHORT).show()
            return
        }
        
        // Validate IP format (basic check)
        val ipPattern = Patterns.IP_ADDRESS
        if (!ipPattern.matcher(ip).matches() && ip != "localhost" && !ip.startsWith("192.168.") && !ip.startsWith("10.") && !ip.startsWith("172.")) {
            Toast.makeText(requireContext(), "Invalid IP address format", Toast.LENGTH_SHORT).show()
            return
        }
        
        // Temporarily update preferences for test
        PreferenceHelper.setWorkstationIp(requireContext(), ip)
        PreferenceHelper.setPort(requireContext(), port)
        
        // Test connection
        testButton.isEnabled = false
        testButton.text = "Testing..."
        
        val baseUrl = PreferenceHelper.getBaseUrl(requireContext())
        println("[Red Trinity] Testing connection to: $baseUrl")
        
        lifecycleScope.launch {
            try {
                val response = RetrofitClient.getApiService(requireContext()).healthCheck()
                activity?.runOnUiThread {
                    testButton.isEnabled = true
                    testButton.text = "TEST CONNECTION"
                    if (response.isSuccessful) {
                        val health = response.body()
                        val message = "✓ Connected!\nStatus: ${health?.status}\nSystem: ${health?.system}"
                        Toast.makeText(requireContext(), message, Toast.LENGTH_LONG).show()
                    } else {
                        val errorMsg = when (response.code()) {
                            404 -> "Server not found. Check IP and port."
                            401 -> "Authentication failed. Check server config."
                            500 -> "Server error. Check server logs."
                            else -> "Connection failed: ${response.code()} ${response.message()}"
                        }
                        Toast.makeText(requireContext(), "✗ $errorMsg", Toast.LENGTH_LONG).show()
                    }
                }
            } catch (e: java.net.UnknownHostException) {
                activity?.runOnUiThread {
                    testButton.isEnabled = true
                    testButton.text = "TEST CONNECTION"
                    Toast.makeText(requireContext(), "✗ Cannot resolve host: $ip\nCheck IP address", Toast.LENGTH_LONG).show()
                }
            } catch (e: java.net.ConnectException) {
                activity?.runOnUiThread {
                    testButton.isEnabled = true
                    testButton.text = "TEST CONNECTION"
                    Toast.makeText(requireContext(), "✗ Cannot connect to $ip:$port\n• Is server running?\n• Same network?\n• Firewall blocking?", Toast.LENGTH_LONG).show()
                }
            } catch (e: java.net.SocketTimeoutException) {
                activity?.runOnUiThread {
                    testButton.isEnabled = true
                    testButton.text = "TEST CONNECTION"
                    Toast.makeText(requireContext(), "✗ Connection timeout\nServer not responding", Toast.LENGTH_LONG).show()
                }
            } catch (e: Exception) {
                activity?.runOnUiThread {
                    testButton.isEnabled = true
                    testButton.text = "TEST CONNECTION"
                    if (e !is kotlinx.coroutines.CancellationException) {
                        val errorType = e.javaClass.simpleName
                        val errorMsg = e.message ?: "Unknown error"
                        Toast.makeText(requireContext(), "✗ Error ($errorType): $errorMsg", Toast.LENGTH_LONG).show()
                    }
                }
            }
        }
    }
}
