package com.redtrinity.pentest.fragments

import android.os.Bundle
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import android.widget.Toast
import androidx.fragment.app.Fragment
import androidx.lifecycle.lifecycleScope
import androidx.recyclerview.widget.LinearLayoutManager
import androidx.recyclerview.widget.RecyclerView
import com.google.android.material.dialog.MaterialAlertDialogBuilder
import com.google.android.material.textfield.TextInputEditText
import com.redtrinity.pentest.R
import com.redtrinity.pentest.adapters.AttackCategoryAdapter
import com.redtrinity.pentest.model.Attack
import com.redtrinity.pentest.network.RetrofitClient
import kotlinx.coroutines.CancellationException
import kotlinx.coroutines.launch

class AttackListFragment : Fragment() {
    
    private lateinit var recyclerView: RecyclerView
    private lateinit var adapter: AttackCategoryAdapter
    private val attacksByCategory = mutableMapOf<String, List<Attack>>()
    
    override fun onCreateView(
        inflater: LayoutInflater,
        container: ViewGroup?,
        savedInstanceState: Bundle?
    ): View? {
        return inflater.inflate(R.layout.fragment_attack_list, container, false)
    }
    
    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
        super.onViewCreated(view, savedInstanceState)
        
        recyclerView = view.findViewById(R.id.recyclerViewAttacks)
        recyclerView.layoutManager = LinearLayoutManager(requireContext())
        
        adapter = AttackCategoryAdapter(
            attacksByCategory,
            onAttackClick = { attack, category ->
                showAttackDialog(attack, category)
            }
        )
        recyclerView.adapter = adapter
        
        loadAttacks()
    }
    
    private fun loadAttacks() {
        if (!::recyclerView.isInitialized) return
        
        lifecycleScope.launch {
            try {
                val response = RetrofitClient.getApiService(requireContext()).listAttacks()
                if (response.isSuccessful) {
                    val attacksMap = response.body()?.attacks ?: emptyMap()
                    activity?.runOnUiThread {
                        attacksByCategory.clear()
                        attacksByCategory.putAll(attacksMap.mapValues { (_, attacks) ->
                            attacks.map { attack ->
                                Attack(
                                    id = attack.id,
                                    name = attack.name,
                                    script = attack.script,
                                    description = attack.description
                                )
                            }
                        })
                        adapter.notifyDataSetChanged()
                    }
                } else {
                    activity?.runOnUiThread {
                        Toast.makeText(requireContext(), "Failed to load attacks: ${response.message()}", Toast.LENGTH_SHORT).show()
                    }
                }
            } catch (e: Exception) {
                activity?.runOnUiThread {
                    if (e !is kotlinx.coroutines.CancellationException) {
                        Toast.makeText(requireContext(), "Connection error: ${e.message}", Toast.LENGTH_LONG).show()
                    }
                }
            }
        }
    }
    
    private fun showAttackDialog(attack: Attack, category: String) {
        val dialogView = layoutInflater.inflate(R.layout.dialog_execute_attack, null)
        val targetInput = dialogView.findViewById<TextInputEditText>(R.id.editTarget)
        
        MaterialAlertDialogBuilder(requireContext())
            .setTitle(attack.name)
            .setMessage(attack.description)
            .setView(dialogView)
            .setPositiveButton("Execute") { _, _ ->
                val target = targetInput?.text?.toString() ?: ""
                if (target.isNotEmpty()) {
                    executeAttack(attack.id, category, target)
                } else {
                    Toast.makeText(requireContext(), "Please enter a target", Toast.LENGTH_SHORT).show()
                }
            }
            .setNegativeButton("Cancel", null)
            .show()
    }
    
    private fun executeAttack(attackId: String, category: String, target: String) {
        lifecycleScope.launch {
            try {
                val request = com.redtrinity.pentest.model.ExecuteAttackRequest(
                    attack_id = attackId,
                    category = category,
                    target = target
                )
                val response = RetrofitClient.getApiService(requireContext()).executeAttack(request)
                activity?.runOnUiThread {
                    if (response.isSuccessful) {
                        val result = response.body()
                        if (result?.success == true) {
                            val message = if (result.output.isNullOrEmpty()) {
                                "✓ Attack executed successfully"
                            } else {
                                // Show first 100 chars of output
                                val outputPreview = result.output.take(100)
                                "✓ Attack executed\n$outputPreview..."
                            }
                            Toast.makeText(requireContext(), message, Toast.LENGTH_LONG).show()
                            // Dashboard will auto-refresh
                        } else {
                            val errorMsg = result?.error ?: "Unknown error"
                            Toast.makeText(requireContext(), "✗ Attack failed: $errorMsg", Toast.LENGTH_LONG).show()
                        }
                    } else {
                        Toast.makeText(requireContext(), "✗ Request failed: ${response.message()}", Toast.LENGTH_SHORT).show()
                    }
                }
            } catch (e: Exception) {
                activity?.runOnUiThread {
                    if (e !is kotlinx.coroutines.CancellationException) {
                        Toast.makeText(requireContext(), "✗ Connection error: ${e.message}", Toast.LENGTH_LONG).show()
                    }
                }
            }
        }
    }
}
