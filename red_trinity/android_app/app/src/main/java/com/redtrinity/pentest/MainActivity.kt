package com.redtrinity.pentest

import android.os.Bundle
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import androidx.lifecycle.lifecycleScope
import com.redtrinity.pentest.databinding.ActivityMainBinding
import com.redtrinity.pentest.network.RetrofitClient
import kotlinx.coroutines.launch

class MainActivity : AppCompatActivity() {
    private lateinit var binding: ActivityMainBinding
    
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        binding = ActivityMainBinding.inflate(layoutInflater)
        setContentView(binding.root)
        
        setupClickListeners()
        checkConnection()
    }
    
    private fun setupClickListeners() {
        binding.btnConnect.setOnClickListener {
            checkConnection()
        }
        
        binding.btnNmapScan.setOnClickListener {
            executeNmapScan()
        }
        
        binding.btnListTools.setOnClickListener {
            listAvailableTools()
        }
        
        binding.btnSystemInfo.setOnClickListener {
            getSystemInfo()
        }
        
        binding.btnHistory.setOnClickListener {
            getCommandHistory()
        }
    }
    
    private fun checkConnection() {
        binding.statusText.text = "Checking connection..."
        lifecycleScope.launch {
            try {
                val response = RetrofitClient.apiService.healthCheck()
                if (response.isSuccessful) {
                    val health = response.body()
                    binding.statusText.text = "Connected: ${health?.status}"
                    binding.statusText.setTextColor(getColor(android.R.color.holo_green_dark))
                } else {
                    binding.statusText.text = "Connection failed"
                    binding.statusText.setTextColor(getColor(android.R.color.holo_red_dark))
                }
            } catch (e: Exception) {
                binding.statusText.text = "Error: ${e.message}"
                binding.statusText.setTextColor(getColor(android.R.color.holo_red_dark))
                Toast.makeText(this@MainActivity, "Connection error: ${e.message}", Toast.LENGTH_LONG).show()
            }
        }
    }
    
    private fun executeNmapScan() {
        val target = binding.editTarget.text.toString()
        if (target.isEmpty()) {
            Toast.makeText(this, "Please enter a target", Toast.LENGTH_SHORT).show()
            return
        }
        
        binding.outputText.text = "Executing Nmap scan on $target..."
        lifecycleScope.launch {
            try {
                val request = com.redtrinity.pentest.model.ExecuteRequest(
                    tool = "nmap",
                    target = target,
                    options = "-sV"
                )
                val response = RetrofitClient.apiService.executeCommand(request)
                if (response.isSuccessful) {
                    val result = response.body()
                    if (result?.success == true) {
                        binding.outputText.text = result.output ?: "Scan completed"
                    } else {
                        binding.outputText.text = "Error: ${result?.error}"
                    }
                } else {
                    binding.outputText.text = "Request failed: ${response.message()}"
                }
            } catch (e: Exception) {
                binding.outputText.text = "Error: ${e.message}"
                Toast.makeText(this@MainActivity, "Execution error: ${e.message}", Toast.LENGTH_LONG).show()
            }
        }
    }
    
    private fun listAvailableTools() {
        binding.outputText.text = "Fetching available tools..."
        lifecycleScope.launch {
            try {
                val response = RetrofitClient.apiService.listTools()
                if (response.isSuccessful) {
                    val tools = response.body()?.tools
                    val toolsList = tools?.entries?.joinToString("\n") { (key, tool) ->
                        "${tool.name}: ${if (tool.available) "✓ Available" else "✗ Not Available"}"
                    } ?: "No tools found"
                    binding.outputText.text = toolsList
                } else {
                    binding.outputText.text = "Failed to fetch tools"
                }
            } catch (e: Exception) {
                binding.outputText.text = "Error: ${e.message}"
            }
        }
    }
    
    private fun getSystemInfo() {
        binding.outputText.text = "Fetching system information..."
        lifecycleScope.launch {
            try {
                val response = RetrofitClient.apiService.getSystemInfo()
                if (response.isSuccessful) {
                    val info = response.body()
                    val infoText = """
                        Hostname: ${info?.hostname}
                        IP: ${info?.ip}
                        OS: ${info?.os}
                        Uptime: ${info?.uptime}
                    """.trimIndent()
                    binding.outputText.text = infoText
                } else {
                    binding.outputText.text = "Failed to fetch system info"
                }
            } catch (e: Exception) {
                binding.outputText.text = "Error: ${e.message}"
            }
        }
    }
    
    private fun getCommandHistory() {
        binding.outputText.text = "Fetching command history..."
        lifecycleScope.launch {
            try {
                val response = RetrofitClient.apiService.getHistory(20)
                if (response.isSuccessful) {
                    val history = response.body()?.history
                    val historyText = history?.joinToString("\n\n") { cmd ->
                        "[${cmd.timestamp}] ${cmd.tool}: ${cmd.command}"
                    } ?: "No history"
                    binding.outputText.text = historyText
                } else {
                    binding.outputText.text = "Failed to fetch history"
                }
            } catch (e: Exception) {
                binding.outputText.text = "Error: ${e.message}"
            }
        }
    }
}

