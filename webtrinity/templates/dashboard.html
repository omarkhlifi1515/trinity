{% extends "base.html" %}

{% block content %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>

<div class="h-screen flex flex-col p-6">
    
    {% if current_user.role == 'manager' %}
    <div class="glass-panel p-6 border-l-4 border-red-500 mb-6">
        <h1 class="text-3xl font-bold neon-text">COMMANDER OVERRIDE</h1>
        <p class="text-gray-400">Assign missions to field agents.</p>
        
        <div class="mt-4 flex gap-4">
            <input id="taskTitle" type="text" placeholder="Mission Objective..." 
                   class="bg-black/50 text-white p-3 rounded w-full border border-gray-700 focus:border-red-500 outline-none">
            <select id="assignee" class="bg-black/50 text-white p-3 rounded border border-gray-700">
                <option value="">All Agents</option>
                {% for u in users %}
                <option value="{{ u.id }}">{{ u.username }}</option>
                {% endfor %}
            </select>
            <button onclick="sendTask()" class="bg-red-600 hover:bg-red-500 text-white px-8 py-3 rounded font-bold tracking-wider">
                DEPLOY
            </button>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="glass-panel p-4">
            <h3 class="text-gray-400 mb-2">MISSION LOG</h3>
            <ul id="chefLog" class="space-y-2 text-sm font-mono text-green-400">
                </ul>
        </div>
    </div>

    <script>
        const socket = io();
        
        function sendTask() {
            const title = document.getElementById('taskTitle').value;
            const assignee = document.getElementById('assignee').value;
            socket.emit('assign_task', { title: title, assignee_id: assignee });
            document.getElementById('taskTitle').value = ''; // Clear input
            
            // Add to own log
            const log = document.getElementById('chefLog');
            log.innerHTML = `<li class="opacity-50"> > Order sent: ${title}</li>` + log.innerHTML;
        }

        socket.on('task_completed_alert', function(data) {
            const log = document.getElementById('chefLog');
            log.innerHTML = `<li class="text-white bg-green-900/30 p-2 rounded"> âœ” AGENT ${data.user} COMPLETED MISSION #${data.task_id}</li>` + log.innerHTML;
            try{ new Audio('/static/success_chime.mp3').play(); } catch(e){}
        });
    </script>

    {% else %}
    <div class="glass-panel p-6 border-l-4 border-[#00ff41] h-full">
        <h1 class="text-3xl font-bold text-[#00ff41]">FIELD AGENT TERMINAL</h1>
        <p class="text-gray-400 mb-6">Awaiting orders from Command...</p>

        <div id="taskContainer" class="space-y-4">
            {% for task in my_tasks %}
                {% if task.status != 'Done' %}
                <div id="task-{{task.id}}" class="bg-gray-900/80 p-4 rounded border border-gray-700 flex justify-between items-center animate-in fade-in slide-in-from-top-4">
                    <div>
                        <span class="text-red-400 text-xs font-bold px-2 py-1 border border-red-400 rounded mr-2">PRIORITY</span>
                        <span class="text-white text-lg">{{ task.title }}</span>
                    </div>
                    <button onclick="finishTask({{task.id}})" class="bg-[#00ff41]/20 hover:bg-[#00ff41]/40 text-[#00ff41] border border-[#00ff41] px-4 py-2 rounded">
                        MARK COMPLETE
                    </button>
                </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <div id="agent-toast" class="fixed bottom-4 right-4 bg-blue-900/90 text-blue-100 p-4 rounded border border-blue-500 hidden max-w-sm">
        <div class="font-bold text-xs text-blue-400 mb-1">TRINITY AI</div>
        <div id="agent-msg"></div>
    </div>

    <script>
        const socket = io();

        // 1. Receive New Task Instantly
        socket.on('new_task_alert', function(data) {
            const container = document.getElementById('taskContainer');
            const html = `
            <div id="task-${data.id}" class="bg-gray-900/80 p-4 rounded border border-red-500/50 shadow-[0_0_15px_rgba(255,0,0,0.2)] flex justify-between items-center animate-pulse">
                <div>
                    <span class="text-red-500 text-xs font-bold px-2 py-1 border border-red-500 rounded mr-2">NEW ORDER</span>
                    <span class="text-white text-lg">${data.title}</span>
                </div>
                <button onclick="finishTask(${data.id})" class="bg-[#00ff41]/20 hover:bg-[#00ff41]/40 text-[#00ff41] border border-[#00ff41] px-4 py-2 rounded">
                    MARK COMPLETE
                </button>
            </div>`;
            container.innerHTML = html + container.innerHTML;
            try{ new Audio('/static/alert.mp3').play(); } catch(e){}
        });

        // 2. Complete Task Logic
        function finishTask(id) {
            socket.emit('complete_task', { task_id: id });
            const el = document.getElementById(`task-${id}`);
            if(el){ el.classList.add('opacity-0'); setTimeout(()=>el.remove(),500); }
        }

        // 3. Receive Agent Reminders
        socket.on('agent_reminder', function(msg) {
            const toast = document.getElementById('agent-toast');
            document.getElementById('agent-msg').innerText = msg;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 5000);
        });
    </script>
    {% endif %}

</div>
{% endblock %}
